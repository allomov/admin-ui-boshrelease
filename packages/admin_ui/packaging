# abort script on any command that exits with a non zero value
set -e -x

cp -a admin_ui ${BOSH_INSTALL_TARGET}
cd ${BOSH_INSTALL_TARGET}/admin_ui


libpq_dir=/var/vcap/packages/libpq
ruby_dir=/var/vcap/packages/ruby
bundle_cmd="$ruby_dir/bin/bundle"

echo "*********"
echo $(pwd)
ls -Lla .

echo "*********"
echo "BOSH_INSTALL_TARGET"
echo $BOSH_INSTALL_TARGET
ls -Lla $BOSH_INSTALL_TARGET

echo "*********"
echo "BOSH_COMPILE_TARGET"
echo $BOSH_COMPILE_TARGET
ls -Lla $BOSH_COMPILE_TARGET

echo "*********"
echo "libpq_dir"
echo $libpq_dir
ls -Lla $libpq_dir

echo "*********"
echo "$libpq_dir/lib" 
ls -Lla $libpq_dir/lib

# echo "*********"
# echo "$libpq_dir/include" 
# ls -la $libpq_dir/include



$bundle_cmd config build.pg --with-pg-dir=$libpq_dir
$bundle_cmd install \
  --local \
  --deployment \
  --without development test \
  --no-prune \
  --binstubs $ruby_dir/bin

# /var/vcap/packages/ruby/bin/bundle install --deployment \
#                                            --without=development test \
#                                            --with-pg-lib=/var/vcap/packages/libpq/lib \
#                                            


cd ${BOSH_INSTALL_TARGET}
cp -a ${BOSH_COMPILE_TARGET}/vcap-common vcap-common
cd vcap-common
/var/vcap/packages/ruby/bin/bundle install --local --deployment --without=development test
